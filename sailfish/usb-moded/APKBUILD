# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Bart Ribbers <bribbers@disroot.org>
pkgname=usb-moded
pkgver=0.86.0
_pkgver=mer/$pkgver+mer40
pkgrel=0
pkgdesc="A daemon activating a certain USB profile based on the usb cable connection status"
url="https://git.sailfishos.org/mer-core/usb-moded"
arch="all"
license="GPL-2.0-only"
depends_dev="dbus-dev glib-dev dbus-glib-dev gobject-introspection-dev eudev-dev kmod-dev libdsme-dev elogind-dev ssu-sysinfo-dev ssu-sysinfo sailfish-access-control"
makedepends="$depends_dev automake autoconf libtool"
subpackages="$pkgname-dev"
source="https://git.sailfishos.org/mer-core/usb-moded/-/archive/$_pkgver/usb-moded-${_pkgver/\//-}.tar.gz
	fix-musl-incompatibility.patch
	fix-pkconf-version.patch
	"
options="!check" # No test suite available
builddir="$srcdir/$pkgname-${_pkgver/\//-}"

prepare() {
	default_prepare

	./autogen.sh
}

build() {
	./configure \
		--prefix=/usr \
		--enable-connman \
		--enable-ofono
	make
}

package() {
	DESTDIR="$pkgdir" make install

	# The pkg-config file isn't installed automatically for some reason
	install -dm 755 "$pkgdir"/usr/lib/pkgconfig
	install -m 644 usb_moded.pc "$pkgdir"/usr/lib/pkgconfig/

	install -dm 755 "$pkgdir"/usr/include/$pkgname
	cp src/*.h src/*.xml "$pkgdir"/usr/include/$pkgname
}

sha512sums="6c35a67fa7a44068af2fe942d9e828ae0456ed76e184c2fde57d319a6de4ab691de84c596f85f26770e30951972527c34204cb9221563bc9d84868042e0c6733  usb-moded-mer-0.86.0+mer40.tar.gz
1736a118f7254e6b449ad91d87616b6e58c59d09a0608b6e5c8e09fa32ec09ad4a2a718d8b86ac80bda52f0eaafdf34e14cbd8ff42cc0bc20433e88fa285498b  fix-musl-incompatibility.patch
20464bb3ab10cd4ad3ec786c4413cbad2677780e2e203d0ed84b1bdeb3c625f90bbb7cd807ab5d732b9660ef588b92efb49ec2f17fbc4b97e68750aab678959e  fix-pkconf-version.patch"
