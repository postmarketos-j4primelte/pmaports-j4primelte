# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=qtmir
pkgver=0_git20200217
_commit="f1a612ce524c57f689b68c6f3b57fdfe8d169560"
pkgrel=0
pkgdesc="QPA plugin to make Qt a Mir server"
arch="all"
url="https://unity8.io"
license="LGPL-3.0"
makedepends="$depends_dev cmake cmake-extras gtest-dev mir-dev process-cpp-dev qt5-qtdeclarative-dev qt5-qtsensors-dev ubuntu-app-launch-dev gsettings-qt-dev libqtdbustest libqtdbusmock content-hub-dev valgrind-dev url-dispatcher-dev"
source="$pkgname-$_commit.tar.gz::https://github.com/ubports/$pkgname/archive/$_commit.tar.gz
	0001-Revert-Use-app-launch-2.patch
	0002-Disable-Werror.patch
	0003-Fix-CMake-error-with-Qt-5.14.patch"
builddir="$srcdir/$pkgname-$_commit"

prepare() {
	default_prepare
	mkdir -p "$builddir"/build

	# Don't build tests, they require Mir to be built with tests which is disabled
	truncate -s 0 "$builddir"/tests/CMakeLists.txt
}

build() {
	cd "$builddir"/build
	cmake \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib ..
	make
}

check() {
	cd "$builddir"/build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest
}

package() {
	cd "$builddir"/build
	make DESTDIR="$pkgdir" install
}

sha512sums="2dbf7672e9075663c213ee24aff36a3d2463f4c002374582adead829d6fa3ac998c6d52995e17d69c62c7c80acc790a8969278caaf9da7c6d27d0ec326177ca7  qtmir-f1a612ce524c57f689b68c6f3b57fdfe8d169560.tar.gz
03fc9960072c58fc06ba9bc9edc6f12d0688d144a6f86d10eb0bce8fc1b2972dfe2fe4234259b2fbf2dbecca4c81ddeee0092f90c31fa62bb25f5bb3400f136f  0001-Revert-Use-app-launch-2.patch
af81b205c4a035c8ee04d57af3a0c2da8ec5b0b284e00c7b55c88b3e19040dd1fbfba706b91c10871af5227808146cc2aa82de2ac362c9c9c240455af129a0fc  0002-Disable-Werror.patch
70e42980491ede0353e273c45dfc22933db20a80016b4a7ea1ec99c39ff064fb5ea04d50e0a6bf6cdb9aec0d1f4ba1f5eee552755892fbab71c6cf8887e01410  0003-Fix-CMake-error-with-Qt-5.14.patch"
