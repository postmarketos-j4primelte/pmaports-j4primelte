# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=unity8
pkgver=0_git20181011
_commit="18c3f6f3c6d6274e1a63562b955bd65f41266fb8"
pkgrel=1
pkgdesc="A convergent desktop environment"
arch="all"
url="https://github.com/ubports/unity8"
license="GPL-3.0 LGPL-2.1"
depends="qt5-qtgraphicaleffects settings-components gsettings-ubuntu-touch-schemas qtmir unity7-schemas suru-icon-theme gsettings-desktop-schemas"
depends_dev="qt5-qtbase-dev qt5-qtdeclarative-dev unity-api-dev geonames-dev qmenumodel-dev qmenumodel gnome-desktop-dev ubuntu-app-launch-dev ubuntu-ui-toolkit-dev libqtdbustest libqtdbusmock indicator-network-dev gsettings-qt-dev libusermetrics-dev lightdm-qt5 lightdm-qt5-dev ubuntu-download-manager-dev linux-pam-dev"
makedepends="$depends_dev cmake cmake-extras dbus-test-runner doxygen graphviz system-settings"
checkdepends="py3-dbusmock"
source="$pkgname-$_commit.tar.gz::https://github.com/ubports/unity8/archive/$_commit.tar.gz
	0001-AndroidAway.patch
	0002-NoDpkgParse.patch
	0003-Add-missing-includes.patch
	0004-Add-qt5-suffix-to-search-for-Qt-tools.patch
	0005-Link-against-libintl.patch
	0006-Add-forceClose-Impl-for-MirSurface-Mock.patch"
subpackages="$pkgname-lang"
builddir="$srcdir/$pkgname-$_commit"

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var
	make -C build
}

check() {
	cd build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "testRootActionState|testWizardSystem"
}

package() {
	make -C build DESTDIR="$pkgdir" install
	# Remove this mock as apk thinks, it conflicts with the qmenumodel package
	rm -r "$pkgdir"/usr/lib/unity8/qml/mocks/QMenuModel/
}

sha512sums="6bf08f06d6046fe8cf68c3c9aa8f6ef273285ac6362e1167bebb00c309d9407418fefc6635f75beb6301b8ec9192952a56544178ade94859a10f59a701b6c39a  unity8-18c3f6f3c6d6274e1a63562b955bd65f41266fb8.tar.gz
2abfb71c0632962afc737a0619882ce4a000ecec7cb32659a933c922b42b14491cb7d7f7326f0b4ed2753c16600ca1b085187717bddee6cd0fed4e7b818d7c69  0001-AndroidAway.patch
541fce025d8dac0081d0887322635a410ebadb0fb04ef2d022349ca4b2c8ff0dc126dae6d554828220a2ebeecc6438baf0cea2378e5cb64ce83f1a7f7e7738e0  0002-NoDpkgParse.patch
a34af2aeb731b1bdef6ece1bbd9bfbb067aad202079dc7bd7373827da9d28ff4928eedc4a881ab39df54c80d39f714187fbbc87bb82b397a9380be8d502b8924  0003-Add-missing-includes.patch
0fdda8a7bbcc1c59f6fdf02a7909b8c9bc601c86a64b3debf4d66aabe9316d348184e9b839596c8bf1dacecda88a3a3de75c910838c704a1f6d2112f29869d0e  0004-Add-qt5-suffix-to-search-for-Qt-tools.patch
232046048e736754bf626d18f0be9268005567fae327432d9fc0607b5a6e241346f3096b7da768e23477dc8e67b08e9e5ce037a38516c6e217807af1b533b771  0005-Link-against-libintl.patch
31cb731d18dc323c2f0bddeea17adbda4930f0e43eca3ad902bf29ce9f8a39aca05d1917fe745bef5f5d4a3228e978e9ffca57b8f5c697a2531748fdc3947329  0006-Add-forceClose-Impl-for-MirSurface-Mock.patch"
