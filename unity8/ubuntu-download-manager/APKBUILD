# Contributor: Bart Ribbers <bribbers@disroot.org>
# Maintainer: Luca Weiss <luca@z3ntu.xyz>
pkgname=ubuntu-download-manager
pkgver=0_git20200118
_commit="6d1d305da3f6e9c3bfba278fb7268b80c48ef7fd"
pkgrel=1
pkgdesc="Provides a service for downloading files while an application is suspended"
arch="all"
url="https://unity8.io"
license="LGPL-3.0"
depends_dev="qt5-qtdeclarative-dev boost-dev glog-dev libnih-dev"
makedepends="$depends_dev cmake cmake-extras gtest-dev gmock"
checkdepends="dbus-test-runner xvfb-run"
source="$pkgname-$_commit.tar.gz::https://github.com/ubports/$pkgname/archive/$_commit.tar.gz
	0001-Enable-and-fix-qml-tests.patch"
subpackages="$pkgname-dev"
builddir="$srcdir/$pkgname-$_commit"

build() {
	cmake -B build \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBEXECDIR=/usr/lib \
		-DCMAKE_INSTALL_LIBDIR=lib
	make -C build
}

check() {
	cd build
	# client_test_* tests time out under QEMU
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "client_test_*"
}

package() {
	make -C build DESTDIR="$pkgdir" install
}

sha512sums="6fd4ff502609db21ddde239ea2a9e087ce42b6d9fe69aa451a4383c03333f95a9d704375096599d81bec36ac69e76c0983d1f2ad3cd41b2aac737cfe3f911030  ubuntu-download-manager-6d1d305da3f6e9c3bfba278fb7268b80c48ef7fd.tar.gz
de80e718e08a554ac8d33118c6500a02b0c703d8eedd5578c532662b6dad017c4fccc376fb2cf7339494a455585f718770ab28508065dc3a2c8c76d7b10c527e  0001-Enable-and-fix-qml-tests.patch"
